name: FB CSV Export (no GCP)

on:
  workflow_dispatch:           # vẫn có nút Run workflow
  schedule:
    - cron: "*/10 * * * *"     # chạy mỗi 10 phút (đổi lại "0 * * * *" nếu muốn mỗi giờ)

permissions:
  contents: write
  actions: read

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      SHEET_ID: 1jkdkGG2A8JS2GE728CwvkeVRFNXG7-28TN9GbXo1SYY
      API_SHEET_NAME: api
      API_SHEET_GID: "1875921302"
      META_TOKEN: "EAAWFqwe8nikBPeFqSZBIYzSe5xDFna54jvMgZCqEwsSpXCyhZAVeb213taZBNukoSwZBdLOAn4TYSMiZCcYwljnQCmJ78Efbbq9n68ckVqZBkSZB7zgZAgZCZCMWbmXCdZBeTJukLggbwKxhBhjGGkbr1s1ZA1P3r9oIHu7tTjRUykD3gKPeZCvEI67PMhEmmcS1goZAKuY"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run exporter
        run: python -u main.py

      # Luôn commit CSV để bạn xem lỗi trong data/latest.csv nếu có
      - name: Commit CSV (even on failure)
        if: always()
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/latest.csv || true
          git commit -m "Update CSV (${GITHUB_RUN_ID})" || echo "No changes"
          git push || echo "No changes to push"

      # Tuỳ chọn: đính kèm CSV làm artifact
      - name: Upload CSV artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latest.csv
          path: data/latest.csv
