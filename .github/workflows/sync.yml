name: FB CSV Export (no GCP)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"

permissions:
  contents: write
  actions: read

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      SHEET_ID: 1jkdkGG2A8JS2GE728CwvkeVRFNXG7-28TN9GbXo1SYY
      API_SHEET_NAME: api
      API_SHEET_GID: "1875921302"
      META_TOKEN: "EAAWFqwe8nikBPnScHGEQ6gb6cpLtqZA76oYKXm9byeiui2s5jZAEZCtgNziLPqcpHuUeyC8Xynwe2k3tmK47VoBfAARFyJWD5oMDD539kPOo5zUUdL6RVfhQ6FZCsRNUUtCarA46jZCkYtfZA378ZAlXHyU2Mogv7zPvvxZCIIUxcBrPf5U6M1ZA5BGpZBZCaaH"
      DEBUG: "0"   # đổi "1" nếu cần soi log cấu hình/ lỗi FB

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Tuỳ chọn: soi nhanh CSV từ Sheet
      - name: Quick check Google Sheet CSV (optional)
        if: env.DEBUG == '1'
        run: |
          echo "D2:D4 ->"
          curl -s "https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${API_SHEET_NAME}&range=D2:D4" || true
          echo
          echo "G2:H ->"
          curl -s "https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${API_SHEET_NAME}&range=G2:H" || true
          echo

      - name: Run exporter
        run: python -u main.py

      - name: Commit CSV (even on failure)
        if: always()
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/latest.csv || true
          git commit -m "Update CSV (${GITHUB_RUN_ID})" || echo "No changes"
          git push || echo "No changes to push"

      - name: Upload CSV artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latest.csv
          path: data/latest.csv
