name: FB CSV Export (no GCP)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # mỗi giờ

permissions:
  contents: write
  actions: read

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      SHEET_ID: 1jkdkGG2A8JS2GE728CwvkeVRFNXG7-28TN9GbXo1SYY
      API_SHEET_NAME: api
      API_SHEET_GID: "1875921302"
      META_TOKEN: "EAAWFqwe8nikBPvDMxZAb4xjdTqiGkPWTB54LargH3igyQbuZCKlHZCsNPjqun1uq7H1D75enYTBxwgZCfPfTeX7UPh00xtvAZAwZCyCIwmWjTLatf84HoTwWwMPsVVQbv8SAwBxRRnUd3upIikBNlkwvjcVzBms97w8HqN6IA3SFmSVEPHxgR84ZBOuAZATUiWQE"
      DEBUG: "0"                 # "1" để soi log
      # === Cấu hình chia nhỏ & nhịp ===
      WINDOW_DAYS: "1"           # 1 ngày/ cửa sổ (hiển thị theo ngày rõ ràng)
      WINDOW_COOLDOWN: "5"       # nghỉ giữa 2 cửa sổ (giây)
      ACCT_COOLDOWN: "8"         # nghỉ giữa các account (giây)
      PACE_MS: "1500"            # ms giữa 2 call API
      RATE_LIMIT_RETRIES: "8"
      RATE_LIMIT_COOLDOWN: "120" # giây nếu dính rate-limit
      PAGE_BURST: "25"
      PAGE_BURST_SLEEP: "5"
      REPORT_TIME: "conversion"  # hoặc "impression"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run exporter
        run: python -u main.py

      - name: Commit CSV (even on failure)
        if: always()
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/latest.csv || true
          git commit -m "Update CSV (${GITHUB_RUN_ID})" || echo "No changes"
          git push || echo "No changes to push"

      - name: Upload CSV artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latest.csv
          path: data/latest.csv
